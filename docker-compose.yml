services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    environment:
      - HOST=${HOST:-localhost}
    depends_on:
      - frontend
      - app
    networks:
      - app-network

  app:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - .:/app
      # Сохраняем .venv из образа: том не даёт хосту перезаписать /app/.venv (см. docs.astral.sh/uv/guides/integration/docker)
      - app_venv:/app/.venv
    depends_on:
      experiments_db:
        condition: service_healthy
      users_db:
        condition: service_healthy
      knowledge_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Application
      - APP_NAME=${APP_NAME}
      - APP_VERSION=${APP_VERSION}
      - DEBUG=${DEBUG}
      - ENVIRONMENT=${ENVIRONMENT}
      - HOST=${HOST}
      - PORT=${PORT}
      - API_VERSION=${API_VERSION}
      - API_PREFIX=${API_PREFIX}
      
      # Database connection details
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - EXPERIMENTS_DB=${EXPERIMENTS_DB}
      - USERS_DB=${USERS_DB}
      - KNOWLEDGE_DB=${KNOWLEDGE_DB}
      
      # Database URLs (Docker)
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@experiments_db:5432/${EXPERIMENTS_DB}
      - USERS_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@users_db:5432/${USERS_DB}
      - KNOWLEDGE_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@knowledge_db:5432/${KNOWLEDGE_DB:-knowledge_db}
      
      # Database Settings
      - DB_POOL_SIZE=${DB_POOL_SIZE}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW}
      - DB_ECHO=${DB_ECHO}
      
      # Redis
      - REDIS_URL=redis://redis:6379/${REDIS_DB}
      - REDIS_DEFAULT_TIMEOUT=${REDIS_DEFAULT_TIMEOUT}
      
      # Security
      - SECRET_KEY=${SECRET_KEY}
      - ALGORITHM=${ALGORITHM}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES}
      - REFRESH_TOKEN_EXPIRE_DAYS=${REFRESH_TOKEN_EXPIRE_DAYS}
      - SESSION_MAX_AGE=${SESSION_MAX_AGE}
      
      # CORS (JSON format for list parsing)
      - CORS_ORIGINS=["http://localhost","http://127.0.0.1","http://localhost:3000","http://localhost:8080","http://localhost:80"]
      - CORS_CREDENTIALS=${CORS_CREDENTIALS:-true}
      - CORS_METHODS=["GET","POST","PUT","DELETE","OPTIONS","PATCH"]
      - CORS_HEADERS=["*"]
      
      # File Upload
      - MAX_FILE_SIZE=${MAX_FILE_SIZE}
      - ALLOWED_IMAGE_TYPES=${ALLOWED_IMAGE_TYPES}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL}
      - LOG_FORMAT=${LOG_FORMAT}
      
      # Admin User
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    networks:
      - app-network

  # React Frontend - Production режим (по умолчанию)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    expose:
      - "80"
    depends_on:
      - app
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:80/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - app-network

  experiments_db:
    image: postgres:15
    volumes:
      - experiments_data:/var/lib/postgresql/data
      - ./sql/init/init_experiments_db.sql:/docker-entrypoint-initdb.d/init_experiments_db.sql
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_DB=${EXPERIMENTS_DB}
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  users_db:
    image: postgres:15
    volumes:
      - users_data:/var/lib/postgresql/data
      - ./sql/init/init_users_db.sql:/docker-entrypoint-initdb.d/init_users_db.sql
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_DB=${USERS_DB}
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  knowledge_db:
    image: postgres:15
    volumes:
      - knowledge_data:/var/lib/postgresql/data
      - ./sql/init/init_knowledge_db.sql:/docker-entrypoint-initdb.d/init_knowledge_db.sql
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_DB=${KNOWLEDGE_DB:-knowledge_db}
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network
      
  redis:
    image: redis:7
    expose:
      - "6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network
  
  loki:
    image: grafana/loki:2.9.0
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki-config.yaml:/etc/loki/local-config.yaml:ro
    ports:
      - "3100:3100"
    networks:
      - app-network

  promtail:
    image: grafana/promtail:latest
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - ./promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - loki
    networks:
      - app-network

  prometheus:
    image: prom/prometheus:v2.51.0
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    ports:
      - "9090:9090"
    networks:
      - app-network

  grafana:
    image: grafana/grafana:10.4.2
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - loki
      - tempo
    volumes:
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    networks:
      - app-network

  tempo:
    image: grafana/tempo:2.5.0
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./tempo-config.yaml:/etc/tempo.yaml:ro
    ports:
      - "3200:3200"   # HTTP API
      - "4317:4317"   # OTLP gRPC
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  experiments_data:
  users_data:
  knowledge_data:
  app_venv: